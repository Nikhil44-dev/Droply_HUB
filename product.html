<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blaupunkt Premium Audio</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="product.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="app-container">
    <header class="main-header">
        <div class="logo">DROPLY<span>HUB</span></div>
        <div class="nav-icons"><i class="fas fa-search"></i> <i class="fas fa-shopping-bag"></i></div>
    </header>

    <section class="image-showcase">
        <div class="promo-badge">
            <span class="off-text">50% OFF</span>
            <span class="sub-text">LIMITED DEAL</span>
        </div>
       <div id="imageSlider" class="image-slider">
        <!-- images loaded from server -->
       </div>
        <div class="slider-hint">Swipe for more →</div>
        <div class="slider-indicators">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </section>

    <main class="content-card">
        <div class="price-container">
            <div id="priceTag" class="price-tag">
                <span class="currency">₹</span><span id="productPrice">0</span>
                <span id="productOriginalPrice" class="original-price"></span>
            </div>
            <div id="productRating" class="rating" style="display:none">
                <i class="fas fa-star"></i> <span id="ratingValue">0</span> <span id="ratingCount"></span>
            </div>
        </div>

        <h1 id="productTitle" class="product-title"></h1>

        <div class="trust-bar">
            <div class="trust-item"><i class="fas fa-shield-alt"></i><span>1 Year Warranty</span></div>
            <div class="trust-item"><i class="fas fa-truck-fast"></i><span>Free Delivery</span></div>
            <div class="trust-item"><i class="fas fa-rotate-left"></i><span>7 Days Return</span></div>
        </div>

        <section id="specsGrid" class="specs-grid">
            <!-- specs generated from server product object -->
        </section>

        <section class="features">
            <h3>Why Choose This?</h3>
            <div id="featuresList">
                <!-- description bullets will be rendered here from server product description -->
            </div>
        </section>
    </main>

    <footer class="footer-action">
        <button class="cart-btn"><i class="fas fa-cart-plus"></i></button>
        <button id="buyNowBtn" class="buy-btn">BUY NOW</button>
    </footer>
</div>

<!-- Purchase detail modal -->
<div id="purchaseOverlay" class="modal-overlay" aria-hidden="true">
    <div class="detail-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <button class="modal-close" aria-label="Close purchase form"></button>
        <h2 id="modalTitle">Confirm Purchase</h2>
        <p class="modal-sub">Please provide your details to complete the order.</p>
        <form id="purchaseForm" class="purchase-form">
            <div class="form-row">
                <label for="buyerName">Name</label>
                <input id="buyerName" name="name" type="text" required placeholder="Your full name">
            </div>
            <div class="form-row">
                <label for="buyerMobile">Mobile</label>
                <input id="buyerMobile" name="mobile" type="tel" inputmode="numeric" pattern="[0-9]{10}" required placeholder="10-digit mobile number">
            </div>
            <div class="form-row">
                <label for="buyerAddress">Address</label>
                <textarea id="buyerAddress" name="address" rows="3" required placeholder="Delivery address"></textarea>
            </div>
            <div class="form-row two-up">
                <div>
                    <label for="sizeSelect">Size</label>
                    <select id="sizeSelect" name="size" required>
                        <option value="" disabled selected>Select size</option>
                        <option>XS</option>
                        <option>S</option>
                        <option>M</option>
                        <option>L</option>
                        <option>XL</option>
                    </select>
                </div>
                <div>
                    <label for="quantity">Quantity</label>
                    <input id="quantity" name="quantity" type="number" min="1" value="1" required>
                </div>
            </div>

            <div class="product-summary">
                <strong>Product:</strong> <span id="summaryProduct"></span>
                <br>
                <strong>Price:</strong> <span id="summaryPrice"></span>
            </div>

            <div class="form-actions">
                <button type="button" class="btn secondary modal-cancel">Cancel</button>
                <button type="submit" class="btn primary">Place Order</button>
            </div>
        </form>
    </div>
</div>

<script>
// Inline JS to handle modal open/close and validation
(function(){
    const buyBtn = document.getElementById('buyNowBtn');
    const overlay = document.getElementById('purchaseOverlay');
    const app = document.querySelector('.app-container');
    const closeBtn = overlay.querySelector('.modal-close');
    const cancelBtn = overlay.querySelector('.modal-cancel');
    const form = document.getElementById('purchaseForm');
    const summaryProduct = document.getElementById('summaryProduct');
    const summaryPrice = document.getElementById('summaryPrice');

    async function openModal(){
        // populate product info (if loaded from server by id)
        let title = document.getElementById('productTitle')?.textContent || '';
        let price = document.getElementById('productPrice')?.textContent || document.getElementById('ratingValue')?.textContent || '';
        // if product id present in query, fetch details
        const params = new URLSearchParams(window.location.search);
        const pid = params.get('id');
        if(pid){
            try{
                const res = await fetch('/api/products');
                const list = await res.json();
                const p = list.find(x=>x.id===pid);
                if(p){
                    title = p.title;
                    price = p.price;
                    document.getElementById('summaryProduct') && (document.getElementById('summaryProduct').textContent = title);
                    document.getElementById('summaryPrice') && (document.getElementById('summaryPrice').textContent = '₹'+p.price);
                    // ensure modal size options reflect product
                    const sizeSelect = document.getElementById('sizeSelect');
                    if(sizeSelect){
                        sizeSelect.innerHTML = '';
                        if(p.size_required && p.sizes && p.sizes.length){
                            const opt0 = document.createElement('option'); opt0.value=''; opt0.disabled=true; opt0.selected=true; opt0.textContent='Select size'; sizeSelect.appendChild(opt0);
                            p.sizes.forEach(s=>{ const o=document.createElement('option'); o.textContent = s; o.value = s; sizeSelect.appendChild(o); });
                            sizeSelect.required = true;
                        } else {
                            // no sizes required - provide one option "N/A"
                            const o=document.createElement('option'); o.textContent='One size'; o.value='one'; sizeSelect.appendChild(o); sizeSelect.required = false;
                        }
                    }
                }
            }catch(e){ /* ignore */ }
        }
        summaryProduct.textContent = String(title).trim();
        summaryPrice.textContent = String(price).trim();

        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');
        app.classList.add('blurred');
        // focus first input
        setTimeout(()=> document.getElementById('buyerName').focus(), 220);
        // prevent background scroll
        document.body.style.overflow = 'hidden';
    }

    function closeModal(){
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
        app.classList.remove('blurred');
        document.body.style.overflow = '';
    }

    buyBtn && buyBtn.addEventListener('click', openModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);
    cancelBtn && cancelBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{
        if(e.target === overlay) closeModal();
    });

    form.addEventListener('submit', async function(e){
    e.preventDefault();

    const mobile = document.getElementById('buyerMobile');
    if(!/^[0-9]{10}$/.test(mobile.value.trim())){
        mobile.focus();
        mobile.setCustomValidity('Enter a valid 10-digit mobile number');
        mobile.reportValidity();
        return;
    } else {
        mobile.setCustomValidity('');
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Placing...';

    const params = new URLSearchParams(window.location.search);
    const pid = params.get('id');

    try {
        const res = await fetch('/api/order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({
                product_id: pid,
                product_title: document.getElementById('productTitle').textContent,
                price: document.getElementById('productPrice').textContent,
                size: document.getElementById('sizeSelect').value,
                quantity: document.getElementById('quantity').value,
                name: document.getElementById('buyerName').value,
                mobile: document.getElementById('buyerMobile').value,
                address: document.getElementById('buyerAddress').value
            })
        });

        const data = await res.json();

        if(data.ok){
            submitBtn.textContent = 'Placed ✓';

            setTimeout(()=>{
                closeModal();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Place Order';
                form.reset();
            }, 1000);
        } else {
            alert('Order failed. Try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Place Order';
        }

    } catch (err){
        alert('Server error. Please try later.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Place Order';
    }
});
})();
</script>
 
<script>
// Load product details from server and populate page
(async function(){
    const params = new URLSearchParams(window.location.search);
    const pid = params.get('id');
    const titleEl = document.getElementById('productTitle');
    const priceEl = document.getElementById('productPrice');
    const origEl = document.getElementById('productOriginalPrice');
    const taglineEl = document.getElementById('productTagline');
    const slider = document.getElementById('imageSlider');
    const specsGrid = document.getElementById('specsGrid');

    if(!pid){
        // no id — show message
        if(titleEl) titleEl.textContent = 'Product not found';
        return;
    }

    try{
        const res = await fetch('/api/products');
        if(!res.ok) throw new Error('Failed to load');
        const list = await res.json();
        const p = list.find(x=>x.id===pid);
        if(!p){ if(titleEl) titleEl.textContent = 'Product not found'; return; }

        // images
        slider.innerHTML = '';
        (p.images||[]).forEach((src, i)=>{
            const img = document.createElement('img');
            img.className = 'hero-img';
            img.src = src;
            img.alt = p.title + (i? ' image '+(i+1): '');
            slider.appendChild(img);
        });

        // fill title, price, tagline
        if(titleEl) titleEl.textContent = p.title || '';
        if(priceEl) priceEl.textContent = p.price || 0;
        if(origEl) origEl.textContent = p.original_price && p.original_price>p.price ? '₹'+p.original_price : '';
        if(taglineEl) taglineEl.textContent = p.description ? (p.description.split('\n')[0] || '') : '';

        // specs: category, quantity, sizes, tags
        specsGrid.innerHTML = '';
        const addSpec = (label, value)=>{
            const d = document.createElement('div'); d.className='spec-card';
            d.innerHTML = `<span class="spec-label">${label}</span><span class="spec-value">${value}</span>`;
            specsGrid.appendChild(d);
        };
        if(p.category) addSpec('Category', p.category);
        addSpec('Stock', p.quantity!=null ? p.quantity : '—');
        if(p.sizes && p.sizes.length) addSpec('Sizes', p.sizes.join(', '));
        if(p.tags && p.tags.length) addSpec('Tags', p.tags.join(', '));

        // update buy modal size options and requirement
        const sizeSelect = document.getElementById('sizeSelect');
        if(sizeSelect){
            sizeSelect.innerHTML = '';
            if(p.size_required && p.sizes && p.sizes.length){
                const opt0 = document.createElement('option'); opt0.value=''; opt0.disabled=true; opt0.selected=true; opt0.textContent='Select size'; sizeSelect.appendChild(opt0);
                p.sizes.forEach(s=>{ const o=document.createElement('option'); o.textContent = s; o.value = s; sizeSelect.appendChild(o); });
                sizeSelect.required = true;
            } else {
                const o=document.createElement('option'); o.textContent='One size'; o.value='one'; sizeSelect.appendChild(o); sizeSelect.required = false;
            }
        }

        // populate features from description: split into lines or sentences
        try{
            const featuresContainer = document.getElementById('featuresList');
            if(featuresContainer){
                featuresContainer.innerHTML = '';
                let parts = [];
                if(p.description){
                    parts = p.description.split('\n').map(s=>s.trim()).filter(Boolean);
                    if(parts.length <= 1){
                        parts = p.description.split('. ').map(s=>s.trim()).filter(Boolean);
                    }
                }
                if(parts.length === 0){
                    const d = document.createElement('div'); d.className='feature-pill'; d.appendChild(document.createTextNode('No additional details.'));
                    featuresContainer.appendChild(d);
                } else {
                    parts.forEach(pt => {
                        const pill = document.createElement('div'); pill.className = 'feature-pill';
                        const icon = document.createElement('i'); icon.className = 'fas fa-check-circle';
                        pill.appendChild(icon);
                        pill.appendChild(document.createTextNode(' ' + pt));
                        featuresContainer.appendChild(pill);
                    });
                }
            }
        }catch(e){ console.error('features render error', e); }

    }catch(err){
        if(titleEl) titleEl.textContent = 'Failed to load product';
        console.error(err);
    }

  const urlParams = new URLSearchParams(window.location.search);
  const ref = urlParams.get('ref');

  if (ref) {
    // affiliate ref backend ko bhejo
    fetch('/api/track-affiliate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ ref })
    });
  }
})();
</script>
</body>
</html>